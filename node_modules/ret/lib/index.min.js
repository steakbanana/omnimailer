var util=require("./util");var types=require("./types");var sets=require("./sets");var positions=require("./positions");module.exports=function(t){var h=0,e,m,b={type:types.ROOT,stack:[]},p=b,r=b.stack,a=[];var j=function(c){util.error(t,"Nothing to repeat at column "+(c-1))};var k=util.strToChars(t);e=k.length;while(h<e){m=k[h++];switch(m){case"\\":m=k[h++];switch(m){case"b":r.push(positions.wordBoundary());break;case"B":r.push(positions.nonWordBoundary());break;case"w":r.push(sets.words());break;case"W":r.push(sets.notWords());break;case"d":r.push(sets.ints());break;case"D":r.push(sets.notInts());break;case"s":r.push(sets.whitespace());break;case"S":r.push(sets.notWhitespace());break;default:if(/\d/.test(m)){r.push({type:types.REFERENCE,value:parseInt(m,10)})}else{r.push({type:types.CHAR,value:m.charCodeAt(0)})}}break;case"^":r.push(positions.begin());break;case"$":r.push(positions.end());break;case"[":var d;if(k[h]==="^"){d=true;h++}else{d=false}var s=util.tokenizeClass(k.slice(h),t);h+=s[1];r.push({type:types.SET,set:s[0],not:d});break;case".":r.push(sets.anyChar());break;case"(":var q={type:types.GROUP,stack:[],remember:true};m=k[h];if(m==="?"){m=k[h+1];h+=2;if(m==="="){q.followedBy=true}else{if(m==="!"){q.notFollowedBy=true}else{if(m!==":"){util.error(t,"Invalid group, character '"+m+"' after '?' at column "+(h-1))}}}q.remember=false}r.push(q);a.push(p);p=q;r=q.stack;break;case")":if(a.length===0){util.error(t,"Unmatched ) at column "+(h-1))}p=a.pop();r=p.options?p.options[p.options.length-1]:p.stack;break;case"|":if(!p.options){p.options=[p.stack];delete p.stack}var o=[];p.options.push(o);r=o;break;case"{":var f=/^(\d+)(,(\d+)?)?\}/.exec(k.slice(h)),g,n;if(f!==null){if(r.length===0){j(h)}g=parseInt(f[1],10);n=f[2]?f[3]?parseInt(f[3],10):Infinity:g;h+=f[0].length;r.push({type:types.REPETITION,min:g,max:n,value:r.pop()})}else{r.push({type:types.CHAR,value:123})}break;case"?":if(r.length===0){j(h)}r.push({type:types.REPETITION,min:0,max:1,value:r.pop()});break;case"+":if(r.length===0){j(h)}r.push({type:types.REPETITION,min:1,max:Infinity,value:r.pop()});break;case"*":if(r.length===0){j(h)}r.push({type:types.REPETITION,min:0,max:Infinity,value:r.pop()});break;default:r.push({type:types.CHAR,value:m.charCodeAt(0)})}}if(a.length!==0){util.error(t,"Unterminated group")}return b};module.exports.types=types;